<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">























  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Gloria Hallelujah:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext">
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png?v=6.7.0">


  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg?v=6.7.0" color="#222">


  <link rel="manifest" href="/icons/manifest.json">


  <meta name="msapplication-config" content="/icons/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="在过去很长一段时间内，HotSpot JVM 的首选垃圾收集器都是 ParNew + CMS 组合。直到 JDK7 中 Hotspot 团队首次公布了 G1（Garbage-First），并在 JDK9 中用 G1 作为默认的垃圾收集器。我们团队最近也将用了很多年的 CMS 换成了 G1 垃圾收集器。 本文主要从 G1 的论文 Garbage-First Garbage Collection 出发">
<meta name="keywords" content="selected,java,jvm">
<meta property="og:type" content="article">
<meta property="og:title" content="G1 垃圾收集器">
<meta property="og:url" content="https://ericfu.me/g1-garbage-collector/index.html">
<meta property="og:site_name" content="Coding Husky">
<meta property="og:description" content="在过去很长一段时间内，HotSpot JVM 的首选垃圾收集器都是 ParNew + CMS 组合。直到 JDK7 中 Hotspot 团队首次公布了 G1（Garbage-First），并在 JDK9 中用 G1 作为默认的垃圾收集器。我们团队最近也将用了很多年的 CMS 换成了 G1 垃圾收集器。 本文主要从 G1 的论文 Garbage-First Garbage Collection 出发">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ericfu.me/images/2019/10/hotspot-legacy-heap-structure.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-heap-regions.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-remember-sets.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-remember-set-maintenance.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-generation-regions-example.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-generation-regions-young-gc-1.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-generation-regions-young-gc-2.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/g1-generation-regions-mixed-gc.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/illustrate-why-need-satb.png">
<meta property="og:image" content="https://ericfu.me/images/2019/10/concurrent-marking.jpg">
<meta property="og:updated_time" content="2019-11-02T09:23:23.116Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="G1 垃圾收集器">
<meta name="twitter:description" content="在过去很长一段时间内，HotSpot JVM 的首选垃圾收集器都是 ParNew + CMS 组合。直到 JDK7 中 Hotspot 团队首次公布了 G1（Garbage-First），并在 JDK9 中用 G1 作为默认的垃圾收集器。我们团队最近也将用了很多年的 CMS 换成了 G1 垃圾收集器。 本文主要从 G1 的论文 Garbage-First Garbage Collection 出发">
<meta name="twitter:image" content="https://ericfu.me/images/2019/10/hotspot-legacy-heap-structure.png">






  <link rel="canonical" href="https://ericfu.me/g1-garbage-collector/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>G1 垃圾收集器 | Coding Husky</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-71209065-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-71209065-1');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coding Husky</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ericfu.me/g1-garbage-collector/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Eric Fu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/2015/12/HuskyAvatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding Husky">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">G1 垃圾收集器

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-01 11:26:03" itemprop="dateCreated datePublished" datetime="2019-11-01T11:26:03+08:00">2019-11-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-11-02 17:23:23" itemprop="dateModified" datetime="2019-11-02T17:23:23+08:00">2019-11-02</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/g1-garbage-collector/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="g1-garbage-collector/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在过去很长一段时间内，HotSpot JVM 的首选垃圾收集器都是 ParNew + CMS 组合。直到 JDK7 中 Hotspot 团队首次公布了 G1（Garbage-First），并在 JDK9 中用 G1 作为默认的垃圾收集器。我们团队最近也将用了很多年的 CMS 换成了 G1 垃圾收集器。</p>
<p>本文主要从 G1 的论文 <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.63.6386&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener">Garbage-First Garbage Collection</a> 出发，结合其他较新的白皮书等，讲解 G1 垃圾收集器的工作原理。</p>
<a id="more"></a>
<h2 id="motivation">Motivation</h2>
<p>论文中给出的理由相当简单：现有的垃圾收集器无法满足<strong>软实时（Soft Real-time）</strong>特性：即让 GC 停顿能大致控制在某个阈值以内，但是又不必像实时系统那样非常严格。这也是很多业务系统都有的诉求。</p>
<p>在过去的 JVM 设计中，如下图所示，堆内存被分割成几个区域 —— Eden、Survivor、Old 的大小都是预先划分好的。对于总内存 64GB 的机器，可能 Old 区大小就有 32GB，即使用并行的方式收集一次仍然需要数秒。近十年，随着内存越来越大，这一问题也变得更为严重。</p>
<figure>
<img src="/images/2019/10/hotspot-legacy-heap-structure.png" alt="Hotspot JVM 经典内存布局"><figcaption>Hotspot JVM 经典内存布局</figcaption>
</figure>
<p>为了达到软实时的目标，同时也是为了更好地应对大内存，G1 将中不再使用上述的内存布局。</p>
<h2 id="基本数据结构">基本数据结构</h2>
<p>首先，我们介绍 G1 种最核心的两个概念：Region 和 Remember Set。</p>
<h3 id="heap-regions">Heap Regions</h3>
<p>如下图所示，G1 垃圾收集器将堆内存空间分成等分的 Regions，物理上不一定连续，逻辑上构成连续的堆地址空间。各个 Mutator 线程（即用户应用的线程）拥有各自的 Thread-Local Allocation Buffer (TLAB），用于降低各个线程分配内存的冲突。</p>
<figure>
<img src="/images/2019/10/g1-heap-regions.png" alt="G1 内存布局：Heap Regions"><figcaption>G1 内存布局：Heap Regions</figcaption>
</figure>
<p>要特别注意的是，<strong>巨型对象（Humongous Object）</strong>，即大小超过 3/4 的 Region 大小的对象会作特殊处理，分配到由一个或多个连续 Region 构成的区域。巨型对象会引起其他一些问题，不过这些已经超出了本文的范畴，总之记得尽量别用就好了。</p>
<p>默认配置下，在满足 Region Size 是 2 的整数幂的前提下，G1 将总内存尽量划分成大约 2048 个 Region。</p>
<h3 id="remember-set-rset">Remember Set (RSet)</h3>
<p>为什么要把堆空间分成 Region 呢？<strong>其主要目的是让各个 Region 相对独立，可以分别进行 GC</strong>，而不是一次性地把所有垃圾收集掉。我们知道现代 GC 算法都是基于可达性标记，而这个过程必须遍历所有 Live Objects 才能完成。那问题来了，如果为了收集一个 Region 的垃圾，却完整的遍历所有 Live Objects，这太奢侈了！</p>
<p>所以，我们需要一个机制来让各个 Region 能独立地进行垃圾收集，这也就是 Remember Set 存在的意义。每个 Region 会有一个对应的 Remember Set，它记录了<strong>哪些内存区域中存在引用当前 Region 中对象的对象。</strong>（<em>all locations that might contain pointers to (live) objects within the region</em>）</p>
<figure>
<img src="/images/2019/10/g1-remember-sets.png" alt="Remember Set 记录引用当前 Region 中对象的 Cards"><figcaption>Remember Set 记录引用当前 Region 中对象的 Cards</figcaption>
</figure>
<p>注意 Remember Set 不是直接记录对象地址，而是记录了那些对象所在的 Card 编号。所谓 Card 就是表示一小块 512 bytes 的内存空间，这里面很可能存在不止一个对象。但是这已经足够了：当我们需要确定当前 Region 有那些对象存在外部引用时（这些对象不能被回收），只要扫描一下这块 Card 中的所有对象即可，这比扫描所有 live objects 要容易的多。</p>
<p>实现上，Remember Set 的实现就是一个 Card 的 Hash Set，并且为每个 GC 线程都有一个本地的 Hash Set，最后的 Remember Set 实际上是这些 Hash Set 的并集。当 Card 数量特别多的时候会退化到 Region 粒度，这时候就要扫描更多的区域来寻找引用，时间换空间。</p>
<h3 id="remember-set-的维护">Remember Set 的维护</h3>
<p>维护上面所说的 Remember Set 势必需要记录对象的引用，通常的做法是在 set 一个引用的时候插入一段代码，这称为 Write Barrier。为了尽可能降低对 Mutator 线程的影响，Write Barrier 的代码应当尽可能简化。G1 的 Write Barrier 实际上只是一个“通知”：将当前 set 引用的事件放到 Remember Set Log 队列中，交给后台专门的 GC 线程处理。</p>
<figure>
<img src="/images/2019/10/g1-remember-set-maintenance.png" alt="RememberSet 的维护"><figcaption>RememberSet 的维护</figcaption>
</figure>
<p>Write Barrier 具体实现如下。当发生 <code>X.f = Y</code> 时，假设 <code>rX</code> 为 X 对象的地址，<code>rY</code> 为 Y 对象的地址，则 Write 的同时还会执行以下逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t = (rX XOR rY) &gt;&gt; LogOfRegionSize  <span class="comment">// 对 X, Y 地址右移得到 Region 编号，并将二者做个 XOR</span><span class="keyword">if</span> (rY == <span class="literal">NULL</span> ? <span class="number">0</span> : t)  <span class="comment">// 忽略两种情况： X.f 被赋值为 NULL，或 X 和 Y 位于同一个 Region 内</span></span><br><span class="line">   rs_enqueue(rX)        <span class="comment">// 如果 Card(X) 还不是 dirty 的，将 X 的地址放进 Log，并把该 card 置为 dirty</span></span><br></pre></td></tr></table></figure>
<p>这里 Dirty Bit 的作用是去除重复的 Cards，考虑到一个 Cards 内经常发生密集的引用赋值（比如对象初始化），去重一下能大幅减少冗余。</p>
<p>最后，后台的 GC 线程则负责从 Remember Set Log 不断取出这些引用赋值发生的 Cards，扫描上面所有的对象，然后更新相应 Region 的 Remember Set。在并发标记发生之前，G1 会确保 Remember Set Log 中的记录都处理完，从而保证并发标记算法一定能拿到最新的、正确的 Remember Set。</p>
<p>极端情况下，如果后台的 GC 进程追不上 Mutator 进程写入的速度，这时候 Mutator 线程会退化到自己处理更新，形成反压机制。</p>
<h2 id="generational-garbage-first">Generational Garbage-First</h2>
<p>G1 名字来自于 Garbage-First 这个理念，即，<strong>以收集到尽可能多的垃圾为第一目标</strong>。每次收集时 G1 会选出垃圾最多的几个 Region，进行一次 Stop-the-world 的收集过程。</p>
<p>但是有趣的是，另一方面 G1 又是一个 Generational （分代）的垃圾收集器，它会从逻辑上将 Region 分成 Young、Old 等不同的 Generation，然后针对它们各自特点应用不同的策略。</p>
<p>G1 论文中提到它有一个 Pure Garbage-First 的模式，但在现在的资料中已经很难看到它的踪影，我猜测实际使用中 Generational 模式要效果好的多。以下我们也会只讨论 Generational 模式的工作方式。</p>
<p>经典的内存布局中，各代的内存区域是完全分开的，而 G1 中的 Generation 只是 Region 的一个动态标志，下图是一个标记了 Generation 的例子。各个 Region 的 Generation 是随着 GC 的进行而不断变化的，甚至各个代有多少 Region 这个比例也是随时调整的。</p>
<figure>
<img src="/images/2019/10/g1-generation-regions-example.png" alt="Generational Regions"><figcaption>Generational Regions</figcaption>
</figure>
<h2 id="evacuation">Evacuation</h2>
<p>为了方便读者理解 G1 收集的过程，我们先看下 Evacuation 的过程，之后再看如何做 Marking。</p>
<p><strong>Generational 模式下 G1 的垃圾收集分为两种：Young GC 和 Mixed GC</strong>。Young GC 只会涉及到 Young Regions，它将 Eden Region 中存活的对象移动到一个或多个新分配的 Survivor Region，之前的 Eden Region 就被归还到 Free list，供以后的新对象分配使用。</p>
<figure>
<img src="/images/2019/10/g1-generation-regions-young-gc-1.png" alt="Young GC - 1"><figcaption>Young GC - 1</figcaption>
</figure>
<p>当区域中对象的 Survive 次数超过阈值（<code>TenuringThreshold</code>）时，Survivor Regions 的对象被移动到 Old Regions；否则和 Eden 的对象一样，继续留在 Survivor Regions 里。</p>
<figure>
<img src="/images/2019/10/g1-generation-regions-young-gc-2.png" alt="Young GC - 2"><figcaption>Young GC - 2</figcaption>
</figure>
<p>多次 Young GC 之后，Old Regions 慢慢累积，直到到达阈值（<code>InitiatingHeapOccupancyPercent</code>，简称 IHOP），我们不得不对 Old Regions 做收集。这个阈值在 G1 中是根据用户设定的 GC 停顿时间动态调整的，也可以人为干预。</p>
<p>对 Old Regions 的收集会同时涉及若干个 Young 和 Old Regions，因此被称为 <strong>Mixed GC</strong>。Mixed GC 很多地方都和 Young GC 类似，不同之处是：它还会选择若干最有潜力的 Old Regions（收集垃圾的效率最高的 Regions），这些选出来要被 Evacuate 的 Region 称为本次的 Collection Set (CSet)。</p>
<figure>
<img src="/images/2019/10/g1-generation-regions-mixed-gc.png" alt="Mixed GC"><figcaption>Mixed GC</figcaption>
</figure>
<p>Mixed GC 的重要性不言而喻：Old Regions 的垃圾就是在这个阶段被收集掉的，也正是因为这样，Mixed GC 是工作量最为繁重的一个环节，如果不加以控制，就会像 CMS 一样发生长时间的 Full GC 停顿。这时候 Region 的设计就发挥出优越性了：只要把每次的 Collection Set 规模控制在一定范围，就能把每次收集的停顿时间软性地控制在 <code>MaxGCPauseMillis</code> 以内。起初这个控制可能不太精准，随着 JVM 的运行估算会越来越准确。</p>
<p>那来不及收集的那些 Region 呢？多来几次就可以了。所以你在 GC 日志中会看到 <code>continue mixed GCs</code> 的字样，代表分批进行的各次收集。这个过程会多次重复，直到垃圾的百分比降到 <code>G1HeapWastePercent</code> 以内，或者到达 <code>G1MixedGCCountTarget</code> 上限。</p>
<p>对于 Young Regions，我们对它有以下特殊优化：</p>
<ol type="1">
<li>Evacuation 的时候，Young Regions 一定会被放到代收集的 Regions 集合（Collection Set）中，原因很简单，绝大多数对象寿命都很短，在 Young Regions 做收集往往绝大部分都是垃圾。</li>
<li>由于上一条，我们获得了一个可观的收益：Remember Set 的维护工作不需要考虑 Young 内的引用修改（换句话说 RSet 只关心 old-to-young 和 old-to-old 的引用），当 Young Region 上发生 Evacuation 时我们再去扫描并构建出它的 RSet 即可。</li>
</ol>
<h2 id="concurrent-marking">Concurrent Marking</h2>
<p>在 Evacuation 之前，我们要通过并发标记来确定哪些对象是垃圾、哪些还活着。G1 中的 Concurrent Marking 是以 Region 为单位的，为了保证结果的正确性，这里用到了 Snapshot-at-the-beginning（SATB）算法。</p>
<p>SATB 算法顾名思义是对 Marking 开始时的一个（逻辑上的）Snapshot 进行标记。为什么要用 Snapshot 呢？下面就是一个直接标记导致问题的例子：对象 X 由于没有被标记到而被标记为垃圾，导致 B 引用失效。</p>
<figure>
<img src="/images/2019/10/illustrate-why-need-satb.png" alt="如果只是对现场情况做标记，可能会漏掉某些对象"><figcaption>如果只是对现场情况做标记，可能会漏掉某些对象</figcaption>
</figure>
<p>SATB 算法为了解决这一问题，在修改引用 <code>X.f = B</code> 之前插入了一个 Write Barrier，记录下被覆写之前的引用地址。这些地址最终也会被 Marking 线程处理，从而确保了所有在 Marking 开始时的引用一定会被标记到。这个 Write Barrier 伪代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t = the previous referenced address  // 记录原本的引用地址</span><br><span class="line">if (t has been marked &amp;&amp; t != NULL)  // 如果地址 t 还没来的及标记，且 t 不为 NULL</span><br><span class="line">    satb_enqueue(t) // 放到 SATB 的待处理队列中，之后会去扫描这个引用</span><br></pre></td></tr></table></figure>
<p>通过以上措施，SATB 确保 Marking 开始时存活的对象一定会被标记到。</p>
<p>标记的过程和 CMS 中是类似的，可以看作一个优化版的 DFS：记当前已经标记到的 offset 为 <code>cur</code>，随着标记的进行 cur 不断向后推进。每当访问到地址 &lt; cur 的对象，就对它做深度扫描，递归标记所有应用；反之，对于地址 &gt; cur 的对象，只标记不扫描，等到 cur 推进到那边的时候再去做扫描。</p>
<figure>
<img src="/images/2019/10/concurrent-marking.jpg" alt="基于 cur 指针实现 Concurrent Marking"><figcaption>基于 cur 指针实现 Concurrent Marking</figcaption>
</figure>
<p>上图中，假设当前 cur 指向对象 c，c有两个引用：a 和 e，其中 a 的地址小于 cur，因而做了扫描；而 e 则仅仅是标记。扫描 a 的过程中又发现了对象 b，b 同样被标记并继续扫描。但是 b 引用的 d 在 cur 之后，所以 d 仅仅是被标记，不再继续扫描。</p>
<p>最后一个问题是：如何处理 Concurrent Marking 中新产生的对象？因为 SATB 算法只保证能标记到开始时 snapshot 的对象，对于新出现的那些对象，我们可以简单地认为它们全都是存活的，毕竟数量不是很多。</p>
<h2 id="references">References</h2>
<ol type="1">
<li>Detlefs, David, et al <strong>Garbage-First Garbage Collection</strong>. Proceedings of the 4th international symposium on Memory management. ACM, 2004.</li>
<li>Printezis, Tony, and David Detlefs. <strong>A Generational Mostly-Concurrent Garbage Collector</strong>. Vol. 36. No. 1. ACM, 2000.</li>
<li><a href="https://www.oracle.com/technetwork/java/javase/tech/memorymanagement-whitepaper-1-150020.pdf" target="_blank" rel="noopener">Memory Management in the Java HotSpot™ Virtual Machine (2006)</a></li>
<li><a href="https://www.redhat.com/en/blog/part-1-introduction-g1-garbage-collector?source=author&amp;term=22991" target="_blank" rel="noopener">Introduction to the G1 Garbage Collector - Matt Robson - RedHat</a></li>
<li><a href="https://www.redhat.com/en/blog/collecting-and-reading-g1-garbage-collector-logs-part-2?source=author&amp;term=22991" target="_blank" rel="noopener">Collecting and reading G1 garbage collector logs - Matt Robson - RedHat</a></li>
<li><a href="https://www.slideshare.net/MonicaBeckwith/con5497" target="_blank" rel="noopener">Garbage First Garbage Collector (G1 GC): Current and Future Adaptability and Ergonomics - Monica Beckwith - Slideshare</a></li>
<li><a href="https://blog.csdn.net/coderlius/article/details/79272773" target="_blank" rel="noopener">详解 JVM Garbage First(G1) 垃圾收集器 - coderlius - CSDN</a></li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Eric Fu</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://ericfu.me/g1-garbage-collector/" title="G1 垃圾收集器">https://ericfu.me/g1-garbage-collector/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/selected/" rel="tag"># selected</a>
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/jvm/" rel="tag"># jvm</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/javadoc-coding-standards/" rel="next" title="Javadoc 最佳实践">
                <i class="fa fa-chevron-left"></i> Javadoc 最佳实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/2015/12/HuskyAvatar.jpg" alt="Eric Fu">
            
              <p class="site-author-name" itemprop="name">Eric Fu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">94</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/fuyufjh" title="GitHub &rarr; https://github.com/fuyufjh" rel="noopener" target="_blank"><i class="iconfont icon-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/fuyufjh" title="Zhihu &rarr; https://www.zhihu.com/people/fuyufjh" rel="noopener" target="_blank"><i class="iconfont icon-zhihu"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://twitter.com/fuyufjh" title="Twitter &rarr; https://twitter.com/fuyufjh" rel="noopener" target="_blank"><i class="iconfont icon-twitter"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://www.linkedin.com/in/njufuyu/" title="LinkedIn &rarr; https://www.linkedin.com/in/njufuyu/" rel="noopener" target="_blank"><i class="iconfont icon-linkedin"></i></a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#motivation"><span class="nav-number">1.</span> <span class="nav-text">Motivation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本数据结构"><span class="nav-number">2.</span> <span class="nav-text">基本数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#heap-regions"><span class="nav-number">2.1.</span> <span class="nav-text">Heap Regions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#remember-set-rset"><span class="nav-number">2.2.</span> <span class="nav-text">Remember Set (RSet)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#remember-set-的维护"><span class="nav-number">2.3.</span> <span class="nav-text">Remember Set 的维护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#generational-garbage-first"><span class="nav-number">3.</span> <span class="nav-text">Generational Garbage-First</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#evacuation"><span class="nav-number">4.</span> <span class="nav-text">Evacuation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#concurrent-marking"><span class="nav-number">5.</span> <span class="nav-text">Concurrent Marking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references"><span class="nav-number">6.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eric Fu</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  
    
  <script id="dsq-count-scr" src="https://ericfu.disqus.com/count.js" async></script>


<script>
  var disqus_config = function () {
    this.page.url = "https://ericfu.me/g1-garbage-collector/";
    this.page.identifier = "g1-garbage-collector/";
    this.page.title = 'G1 垃圾收集器';
    };
  function loadComments () {
    var d = document, s = d.createElement('script');
    s.src = 'https://ericfu.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>

  





  





  

  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: "AMS"
      }
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
      for (i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<style>
.MathJax_Display {
  overflow: auto hidden;
}
</style><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    
  


  

  

  

  

  

  

  

  
  

  
  

  


</body>
</html>
