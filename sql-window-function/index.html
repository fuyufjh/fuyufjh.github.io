<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">























  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Gloria Hallelujah:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext">
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png?v=6.7.0">


  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg?v=6.7.0" color="#222">


  <link rel="manifest" href="/icons/manifest.json">


  <meta name="msapplication-config" content="/icons/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="窗口函数（Window Function）是 SQL2003 标准中定义的一项新特性，并在 SQL2011、SQL2016 中又加以完善，添加了若干处拓展。窗口函数不同于我们熟悉的普通函数和聚合函数，它为每行数据进行一次计算：输入多行（一个窗口）、返回一个值。在报表等分析型查询中，窗口函数能优雅地表达某些需求，发挥不可替代的作用。 本文首先介绍窗口函数的定义及基本语法，之后将介绍在 DBMS 和">
<meta name="keywords" content="selected,database,optimizer,sql">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL 窗口函数的优化和执行">
<meta property="og:url" content="https://ericfu.me/sql-window-function/index.html">
<meta property="og:site_name" content="Coding Husky">
<meta property="og:description" content="窗口函数（Window Function）是 SQL2003 标准中定义的一项新特性，并在 SQL2011、SQL2016 中又加以完善，添加了若干处拓展。窗口函数不同于我们熟悉的普通函数和聚合函数，它为每行数据进行一次计算：输入多行（一个窗口）、返回一个值。在报表等分析型查询中，窗口函数能优雅地表达某些需求，发挥不可替代的作用。 本文首先介绍窗口函数的定义及基本语法，之后将介绍在 DBMS 和">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ericfu.me/images/2019/08/banner-cat-on-window.jpg">
<meta property="og:image" content="https://ericfu.me/images/2019/08/windows-function-concepts.png">
<meta property="og:image" content="https://ericfu.me/images/2019/08/frame-rows-range.png">
<meta property="og:image" content="https://ericfu.me/images/2019/08/sql-logical-evaluate-order.png">
<meta property="og:image" content="https://ericfu.me/images/2019/08/window-function-execution.png">
<meta property="og:image" content="https://ericfu.me/images/2019/08/window-function-optimization.png">
<meta property="og:image" content="https://ericfu.me/images/2019/08/segment-tree-sum.jpg">
<meta property="og:updated_time" content="2019-11-30T06:04:49.375Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SQL 窗口函数的优化和执行">
<meta name="twitter:description" content="窗口函数（Window Function）是 SQL2003 标准中定义的一项新特性，并在 SQL2011、SQL2016 中又加以完善，添加了若干处拓展。窗口函数不同于我们熟悉的普通函数和聚合函数，它为每行数据进行一次计算：输入多行（一个窗口）、返回一个值。在报表等分析型查询中，窗口函数能优雅地表达某些需求，发挥不可替代的作用。 本文首先介绍窗口函数的定义及基本语法，之后将介绍在 DBMS 和">
<meta name="twitter:image" content="https://ericfu.me/images/2019/08/banner-cat-on-window.jpg">






  <link rel="canonical" href="https://ericfu.me/sql-window-function/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>SQL 窗口函数的优化和执行 | Coding Husky</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-71209065-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-71209065-1');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coding Husky</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ericfu.me/sql-window-function/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Eric Fu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/2015/12/HuskyAvatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding Husky">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">SQL 窗口函数的优化和执行

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-21 23:24:21" itemprop="dateCreated datePublished" datetime="2019-08-21T23:24:21+08:00">2019-08-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-11-30 14:04:49" itemprop="dateModified" datetime="2019-11-30T14:04:49+08:00">2019-11-30</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/sql-window-function/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="sql-window-function/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/images/2019/08/banner-cat-on-window.jpg"></p>
<p><strong>窗口函数（Window Function）</strong>是 SQL2003 标准中定义的一项新特性，并在 SQL2011、SQL2016 中又加以完善，添加了若干处拓展。窗口函数不同于我们熟悉的普通函数和聚合函数，它为每行数据进行一次计算：<strong>输入多行（一个窗口）、返回一个值</strong>。在报表等分析型查询中，窗口函数能优雅地表达某些需求，发挥不可替代的作用。</p>
<p>本文首先介绍窗口函数的定义及基本语法，之后将介绍在 DBMS 和大数据系统中是如何实现高效计算窗口函数的，包括窗口函数的优化、执行以及并行执行。</p>
<a id="more"></a>
<h2 id="什么是窗口函数">什么是窗口函数？</h2>
<p>窗口函数出现在 SELECT 子句的表达式列表中，它最显著的特点就是 <code>OVER</code> 关键字。语法定义如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">window_function (expression) OVER (</span><br><span class="line">   [ PARTITION BY part_list ]</span><br><span class="line">   [ ORDER BY order_list ]</span><br><span class="line">   [ &#123; ROWS | RANGE &#125; BETWEEN frame_start AND frame_end ] )</span><br></pre></td></tr></table></figure>
<p>其中包括以下可选项：</p>
<ul>
<li><strong>PARTITION BY</strong> 表示将数据先按 <code>part_list</code> 进行分区</li>
<li><strong>ORDER BY</strong> 表示将各个分区内的数据按 <code>order_list</code> 进行排序</li>
</ul>
<figure>
<img src="/images/2019/08/windows-function-concepts.png" alt="Figure 1. 窗口函数的基本概念"><figcaption>Figure 1. 窗口函数的基本概念</figcaption>
</figure>
<p>最后一项表示 Frame 的定义，即：当前窗口包含哪些数据？</p>
<ul>
<li><strong>ROWS</strong> 选择前后几行，例如 <code>ROWS BETWEEN 3 PRECEDING AND 3 FOLLOWING</code> 表示往前 3 行到往后 3 行，一共 7 行数据（或小于 7 行，如果碰到了边界）</li>
<li><strong>RANGE</strong> 选择数据范围，例如 <code>RANGE BETWEEN 3 PRECEDING AND 3 FOLLOWING</code> 表示所有值在 <span class="math inline">\([c-3,c+3]\)</span> 这个范围内的行，<span class="math inline">\(c\)</span> 为当前行的值</li>
</ul>
<figure>
<img src="/images/2019/08/frame-rows-range.png" alt="Figure 2. Rows 窗口和 Range 窗口"><figcaption>Figure 2. Rows 窗口和 Range 窗口</figcaption>
</figure>
<p>逻辑语义上说，一个窗口函数的计算“过程”如下：</p>
<ol type="1">
<li>按窗口定义，将所有输入数据分区、再排序（如果需要的话）</li>
<li>对每一行数据，计算它的 Frame 范围</li>
<li>将 Frame 内的行集合输入窗口函数，计算结果填入当前行</li>
</ol>
<p>举个例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dealer_id, emp_name, sales,</span><br><span class="line">       ROW_NUMBER() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dealer_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">AVG</span>(sales) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dealer_id) <span class="keyword">AS</span> avgsales </span><br><span class="line"><span class="keyword">FROM</span> sales</span><br></pre></td></tr></table></figure>
<p>上述查询中，<code>rank</code> 列表示在当前经销商下，该雇员的销售排名；<code>avgsales</code> 表示当前经销商下所有雇员的平均销售额。查询结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+------------+-----------------+--------+------+---------------+</span><br><span class="line">| dealer_id  | emp_name        | sales  | rank | avgsales      |</span><br><span class="line">+------------+-----------------+--------+------+---------------+</span><br><span class="line">| 1          | Raphael Hull    | 8227   | 1    | 14356         |</span><br><span class="line">| 1          | Jack Salazar    | 9710   | 2    | 14356         |</span><br><span class="line">| 1          | Ferris Brown    | 19745  | 3    | 14356         |</span><br><span class="line">| 1          | Noel Meyer      | 19745  | 4    | 14356         |</span><br><span class="line">| 2          | Haviva Montoya  | 9308   | 1    | 13924         |</span><br><span class="line">| 2          | Beverly Lang    | 16233  | 2    | 13924         |</span><br><span class="line">| 2          | Kameko French   | 16233  | 3    | 13924         |</span><br><span class="line">| 3          | May Stout       | 9308   | 1    | 12368         |</span><br><span class="line">| 3          | Abel Kim        | 12369  | 2    | 12368         |</span><br><span class="line">| 3          | Ursa George     | 15427  | 3    | 12368         |</span><br><span class="line">+------------+-----------------+--------+------+---------------+</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：语法中每个部分都是可选的：</p>
<ul>
<li>如果不指定 <code>PARTITION BY</code>，则不对数据进行分区；换句话说，所有数据看作同一个分区</li>
<li>如果不指定 <code>ORDER BY</code>，则不对各分区做排序，通常用于那些顺序无关的窗口函数，例如 <code>SUM()</code></li>
<li>如果不指定 Frame 子句，则默认采用以下的 Frame 定义：
<ul>
<li>若不指定 <code>ORDER BY</code>，默认使用分区内所有行 <code>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code></li>
<li>若指定了 <code>ORDER BY</code>，默认使用分区内第一行到当前值 <code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code></li>
</ul></li>
</ul>
</blockquote>
<p>最后，窗口函数可以分为以下 3 类：</p>
<ul>
<li><strong>聚合（Aggregate）</strong>：<code>AVG()</code>, <code>COUNT()</code>, <code>MIN()</code>, <code>MAX()</code>, <code>SUM()</code>...</li>
<li><strong>取值（Value）</strong>：<code>FIRST_VALUE()</code>, <code>LAST_VALUE()</code>, <code>LEAD()</code>, <code>LAG()</code>...</li>
<li><strong>排序（Ranking）</strong>：<code>RANK()</code>, <code>DENSE_RANK()</code>, <code>ROW_NUMBER()</code>, <code>NTILE()</code>...</li>
</ul>
<p>受限于篇幅，本文不去探讨各个窗口函数的含义，有兴趣的读者可以参考<a href="https://drill.apache.org/docs/sql-window-functions-introduction/#types-of-window-functions" target="_blank" rel="noopener">这篇文档</a>。</p>
<blockquote>
<p>注：Frame 定义并非所有窗口函数都适用，比如 <code>ROW_NUMBER()</code>、<code>RANK()</code>、<code>LEAD()</code> 等。这些函数总是应用于整个分区，而非当前 Frame。</p>
</blockquote>
<h2 id="窗口函数-vs.-聚合函数">窗口函数 VS. 聚合函数</h2>
<p>从<em>聚合</em>这个意义上出发，似乎窗口函数和 Group By 聚合函数都能做到同样的事情。但是，它们之间的相似点也仅限于此了！这其中的关键区别在于：<strong>窗口函数仅仅只会将结果附加到当前的结果上，它不会对已有的行或列做任何修改</strong>。而 Group By 的做法完全不同：对于各个 Group 它仅仅会保留一行聚合结果。</p>
<p>有的读者可能会问，加了窗口函数之后返回结果的顺序明显发生了变化，这不算一种修改吗？因为 SQL 及关系代数都是以 multi-set 为基础定义的，<strong>结果集本身并没有顺序可言</strong>，<code>ORDER BY</code> 仅仅是最终呈现结果的顺序。</p>
<p>另一方面，从逻辑语义上说，SELECT 语句的各个部分可以看作是按以下顺序“执行”的：</p>
<figure>
<img src="/images/2019/08/sql-logical-evaluate-order.png" alt="Figure 3. SQL 各部分的逻辑执行顺序"><figcaption>Figure 3. SQL 各部分的逻辑执行顺序</figcaption>
</figure>
<p>注意到窗口函数的求值仅仅位于 <code>ORDER BY</code> 之前，而位于 SQL 的绝大部分之后。这也和窗口函数<strong>只附加、不修改</strong>的语义是呼应的——结果集在此时已经确定好了，再依此计算窗口函数。</p>
<h2 id="窗口函数的执行">窗口函数的执行</h2>
<p>窗口函数经典的执行方式分为<strong>排序</strong>和<strong>函数求值</strong>这 2 步。</p>
<figure>
<img src="/images/2019/08/window-function-execution.png" alt="Figure 4. 一个窗口函数的执行过程，通常分为排序和求值 2 步"><figcaption>Figure 4. 一个窗口函数的执行过程，通常分为排序和求值 2 步</figcaption>
</figure>
<p>窗口定义中的 <code>PARTITION BY</code> 和 <code>ORDER BY</code> 都很容易通过排序完成。例如，对于窗口 <code>PARTITION BY a, b ORDER BY c, d</code>，我们可以对输入数据按 <span class="math inline">\((a, b, c, d)\)</span> 或 <span class="math inline">\((b, a, c, d)\)</span> 做排序，之后数据就排列成 Figure 1 中那样了。</p>
<p>接下来考虑：<strong>如何处理 Frame？</strong></p>
<ul>
<li>对于整个分区的 Frame（例如 <code>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code>），只要对整个分区计算一次即可，没什么好说的；</li>
<li>对于逐渐增长的 Frame（例如 <code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code>），可以用 Aggregator 维护累加的状态，这也很容易实现；</li>
<li>对于滑动的 Frame（例如 <code>ROWS BETWEEN 3 PRECEDING AND 3 FOLLOWING</code>）相对困难一些。一种经典的做法是要求 Aggregator 不仅支持增加还支持删除（Removable），这可能比你想的要更复杂，例如考虑下 <code>MAX()</code> 的实现。</li>
</ul>
<h2 id="窗口函数的优化">窗口函数的优化</h2>
<p>对于窗口函数，优化器能做的优化有限。这里为了行文的完整性，仍然做一个简要的说明。</p>
<p>通常，我们首先会把窗口函数从 Project 中抽取出来，成为一个独立的算子称之为 Window。</p>
<figure>
<img src="/images/2019/08/window-function-optimization.png" alt="Figure 5. 窗口函数的优化过程"><figcaption>Figure 5. 窗口函数的优化过程</figcaption>
</figure>
<p>有时候，一个 SELECT 语句中包含多个窗口函数，它们的窗口定义（<code>OVER</code> 子句）可能相同、也可能不同。显然，对于相同的窗口，完全没必要再做一次分区和排序，我们可以将它们合并成一个 Window 算子。</p>
<p>对于不同的窗口，最朴素地，我们可以将其全部分成不同的 Window，如上图所示。实际执行时，<strong>每个 Window 都需要先做一次排序</strong>，代价不小。</p>
<p>那是否可能利用一次排序计算多个窗口函数呢？某些情况下，这是可能的。例如本文例子中的 2 个窗口函数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">... ROW_NUMBER() OVER (PARTITION BY dealer_id ORDER BY sales) AS rank,</span><br><span class="line">    AVG(sales) OVER (PARTITION BY dealer_id) AS avgsales ...</span><br></pre></td></tr></table></figure>
<p>虽然这 2 个窗口并非完全一致，但是 <code>AVG(sales)</code> 不关心分区内的顺序，完全可以复用 <code>ROW_NUMBER()</code> 的窗口。<a href="http://vldb.org/pvldb/vol5/p1244_yucao_vldb2012.pdf" target="_blank" rel="noopener">这篇论文</a> 提供了一种启发式的算法，能尽可能利用能够复用的机会。</p>
<h2 id="窗口函数的并行执行">窗口函数的并行执行 *</h2>
<p>现代 DBMS 大多支持并行执行。对于窗口函数，由于各个分区之间的计算完全不相关，我们可以很容易地将各个分区分派给不同的节点（线程），从而达到<strong>分区间并行</strong>。</p>
<p>但是，如果窗口函数只有一个全局分区（无 <code>PARTITION BY</code> 子句），或者分区数量很少、不足以充分并行时，怎么办呢？上文中我们提到的 Removable Aggregator 的技术显然无法继续使用了，它依赖于单个 Aggregator 的内部状态，很难有效地并行起来。</p>
<p>TUM 的<a href="http://www.vldb.org/pvldb/vol8/p1058-leis.pdf" target="_blank" rel="noopener">这篇论文</a>中提出使用<strong>线段树</strong>（Segment Tree）实现高效的<strong>分区内并行</strong>。<a href="https://en.wikipedia.org/wiki/Segment_tree" target="_blank" rel="noopener">线段树</a>是一个 N 叉树数据结构，每个节点包含当前节点下的部分聚合结果。</p>
<p>下图是一个使用二叉线段树计算 <code>SUM()</code> 的例子。例如下图中第三行的 <span class="math inline">\(12\)</span>，表示叶节点 <span class="math inline">\(5+7\)</span> 的聚合结果；而它上方的 <span class="math inline">\(25\)</span> 表示叶节点 <span class="math inline">\(5+7+3+10\)</span> 的聚合结果。</p>
<figure>
<img src="/images/2019/08/segment-tree-sum.jpg" alt="Figure 6. 使用线段树计算给定范围的总和"><figcaption>Figure 6. 使用线段树计算给定范围的总和</figcaption>
</figure>
<p>假设当前 Frame 是第 2 到第 8 行，即需要计算 <span class="math inline">\(7+3+10+...+4\)</span> 区间之和。有了线段树以后，我们可以直接利用 <span class="math inline">\(7+13+20\)</span> （图中红色字体）计算出聚合结果。</p>
<p>线段树可以在 <span class="math inline">\(O(n\log{n})\)</span> 时间内构造，并能在 <span class="math inline">\(O(\log{n})\)</span> 时间内查询任意区间的聚合结果。更棒的是，不仅查询可以多线程并发互不干扰，而且线段树的构造过程也能被很好地并行起来。</p>
<h2 id="references">References</h2>
<ol type="1">
<li><a href="http://www.vldb.org/pvldb/vol8/p1058-leis.pdf" target="_blank" rel="noopener">Efficient Processing of Window Functions in Analytical SQL Queries - Leis, Viktor, et al. (VLDB'15)</a></li>
<li><a href="http://vldb.org/pvldb/vol5/p1244_yucao_vldb2012.pdf" target="_blank" rel="noopener">Optimization of Analytic Window Functions - Cao, Yu, et al. (VLDB'12)</a></li>
<li><a href="https://drill.apache.org/docs/sql-window-functions-introduction/" target="_blank" rel="noopener">SQL Window Functions Introduction - Apache Drill</a></li>
<li><a href="https://modern-sql.com/blog/2019-02/postgresql-11" target="_blank" rel="noopener">PostgreSQL 11 Reestablishes Window Functions Leadership</a></li>
<li><a href="https://www.red-gate.com/simple-talk/sql/learn-sql-server/window-functions-in-sql-server/" target="_blank" rel="noopener">Window Functions in SQL Server</a></li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Eric Fu</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://ericfu.me/sql-window-function/" title="SQL 窗口函数的优化和执行">https://ericfu.me/sql-window-function/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/selected/" rel="tag"># selected</a>
          
            <a href="/tags/database/" rel="tag"># database</a>
          
            <a href="/tags/optimizer/" rel="tag"># optimizer</a>
          
            <a href="/tags/sql/" rel="tag"># sql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/subquery-optimization/" rel="next" title="SQL 子查询的优化">
                <i class="fa fa-chevron-left"></i> SQL 子查询的优化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/javadoc-coding-standards/" rel="prev" title="Javadoc 最佳实践">
                Javadoc 最佳实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/2015/12/HuskyAvatar.jpg" alt="Eric Fu">
            
              <p class="site-author-name" itemprop="name">Eric Fu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">94</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/fuyufjh" title="GitHub &rarr; https://github.com/fuyufjh" rel="noopener" target="_blank"><i class="iconfont icon-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/fuyufjh" title="Zhihu &rarr; https://www.zhihu.com/people/fuyufjh" rel="noopener" target="_blank"><i class="iconfont icon-zhihu"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://twitter.com/fuyufjh" title="Twitter &rarr; https://twitter.com/fuyufjh" rel="noopener" target="_blank"><i class="iconfont icon-twitter"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://www.linkedin.com/in/njufuyu/" title="LinkedIn &rarr; https://www.linkedin.com/in/njufuyu/" rel="noopener" target="_blank"><i class="iconfont icon-linkedin"></i></a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是窗口函数"><span class="nav-number">1.</span> <span class="nav-text">什么是窗口函数？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数-vs.-聚合函数"><span class="nav-number">2.</span> <span class="nav-text">窗口函数 VS. 聚合函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数的执行"><span class="nav-number">3.</span> <span class="nav-text">窗口函数的执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数的优化"><span class="nav-number">4.</span> <span class="nav-text">窗口函数的优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数的并行执行"><span class="nav-number">5.</span> <span class="nav-text">窗口函数的并行执行 *</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references"><span class="nav-number">6.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eric Fu</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  
    
  <script id="dsq-count-scr" src="https://ericfu.disqus.com/count.js" async></script>


<script>
  var disqus_config = function () {
    this.page.url = "https://ericfu.me/sql-window-function/";
    this.page.identifier = "sql-window-function/";
    this.page.title = 'SQL 窗口函数的优化和执行';
    };
  function loadComments () {
    var d = document, s = d.createElement('script');
    s.src = 'https://ericfu.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>

  





  





  

  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: "AMS"
      }
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
      for (i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<style>
.MathJax_Display {
  overflow: auto hidden;
}
</style><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    
  


  

  

  

  

  

  

  

  
  

  
  

  


</body>
</html>
